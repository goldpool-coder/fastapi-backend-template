# docker-compose.yml

version: '3.8'

services:
  # -------------------------------------------------
  # FastAPI 应用服务
  # 这是此 docker-compose 文件管理的唯一服务。
  # -------------------------------------------------
  app:
    # 使用当前目录下的 Dockerfile 来构建镜像
    build:
      context: .
      dockerfile: Dockerfile

    # 为容器指定一个明确的名称，方便管理
    container_name: fastapi-backend-app

    # 将主机的 8000 端口映射到容器的 8000 端口
    ports:
      - "8000:8000"

    # 指定包含环境变量的 .env 文件
    # docker-compose 会自动加载此文件中的配置
    env_file:
      - .env

    # 将本地的 uploads 和 logs 目录挂载到容器内部
    # 这样上传的文件和生成的日志就能持久化保存在主机上
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

    # [核心配置] 将此服务连接到外部网络
    networks:
      - shared_network # 这是下面定义的网络别名

    # 配置重启策略：除非手动停止，否则容器总是在退出后自动重启
    restart: unless-stopped

# -------------------------------------------------
# 网络定义
# 告诉 Docker Compose 如何处理我们需要的网络。
# -------------------------------------------------
networks:
  # 为外部网络起一个在当前 compose 文件中使用的别名
  shared_network:
    # 声明这是一个已经存在的外部网络
    external: true
    # 指定外部网络的实际名称
    name: shared-services-net

